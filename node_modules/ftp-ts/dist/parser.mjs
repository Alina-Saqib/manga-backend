import{Writable as e}from"stream";const t=/^total/,r=/(?:^|\r?\n)(\d{3}) [^\r\n]*\r?\n/,s=/\r?\n/g,n=/-/g,a=new Map([["jan",1],["feb",2],["mar",3],["apr",4],["may",5],["jun",6],["jul",7],["aug",8],["sep",9],["oct",10],["nov",11],["dec",12]]);class Parser extends e{constructor(e){super(),this._buffer="",this._debug=e.debug}static parseFeat(e){const t=e.split(s);t.shift(),t.pop();for(let e=0,r=t.length;e<r;++e)t[e]=t[e].trim();return t}async _write(e,t,s){const n=this._debug;let a;for(n&&n("[parser] write()"),this._buffer+=e.toString("binary"),n&&n("[parser] buffer: "+this._buffer);a=r.exec(this._buffer);){const e=this._buffer.substring(a.index+a[0].length);e.length&&(this._buffer=this._buffer.substring(0,a.index+a[0].length)),n&&n("[parser] < "+this._buffer);const t=parseInt(a[1],10);let r="(^|\\r?\\n)";r+=a[1],r+="(?: |\\-)";const s=new RegExp(r,"g"),i=this._buffer.replace(s,"$1").trim();this._buffer=e,n&&n("[parser] Response: code="+t+", buffer="+i),await this.emit("response",t,i)}s()}}const i=/^([-ld])((?:[-r][-w][-xstT]){3})(\+)?\s+(\d+)\s+(\S+)\s+(\S+)\s+(\d+)\s+(?:(?:(\w{3})\s+(\d{1,2})\s+(\d{1,2}):(\d{2}))|(?:(\w{3})\s+(\d{1,2})\s+(\d{4})))\s+(.+)$/,o=/^(\d{2})(?:-|\/)(\d{2})(?:-|\/)(\d{2,4})\s+(\d{2}):(\d{2})\s{0,1}([AaMmPp]{1,2})\s+(?:(\d+)|(<DIR>))\s+(.+)$/;function p(e){return(4&e?"r":"-")+(2&e?"w":"-")+(1&e?"x":"-")}function d(e){const t=(e=>{const t={name:""};for(;e&&!e.startsWith(" ");){const r=e.indexOf("=");if(-1==r)return"unexpected entry fact, no equals";const s=e.indexOf(";",r);if(-1==s)return"unexpected entry fact, no semicolon";t[e.substring(0,r).toLowerCase().replace(/-./g,(e=>e.substring(1).toUpperCase())).replace(/^.*?\./,(e=>e.toUpperCase()))]=e.substring(r+1,s),e=e.substring(s+1)}return e&&e.startsWith(" ")?(t.name=e.substring(1),t):"unexpected entry char, expected space followed by filename"})(e);if("string"==typeof t)return e;const r={acl:void 0,date:void 0,group:t["UNIX.groupname"]||t["UNIX.group"],name:t.name,owner:t["UNIX.ownername"]||t["UNIX.owner"],rights:void 0,size:t.size?parseInt(t.size,10):-1,sticky:!1,target:void 0,type:"dir"==t.type||"cdir"==t.type||"pdir"==t.type?"d":"-"};if(t.modify){const e=/^(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\.\d+)?$/.exec(t.modify);if(e){let t=0;if(e[7]){const r=parseInt(e[7].substring(1)),s=4-e[7].length;t=0==s?r:s>0?r*Math.pow(10,s):r/Math.pow(10,-s)}r.date=new Date(Date.UTC(parseInt(e[1]),parseInt(e[2])-1,parseInt(e[3]),parseInt(e[4]),parseInt(e[5]),parseInt(e[6]),t))}}if(t["UNIX.mode"]&&4==t["UNIX.mode"].length){const e=parseInt(t["UNIX.mode"],8);r.rights={user:p(e>>6),group:p(e>>3),other:p(e)}}else if(t.perm){let e=0;for(let r=0;r<t.perm.length;r++)switch(t.perm[r]){case"a":case"c":case"m":case"p":case"w":e|=2;break;case"r":e|=4;break;case"e":case"l":e|=1}r.rights={user:p(e),group:"---",other:"---"}}return Object.assign(r,{mlsx:t})}function u(e){let r;if(r=(e=>{const t=e.match(i);return t?{acl:t[3],date1:t[9],date2:t[13],group:t[6],hour:t[10],inodes:t[4],minute:t[11],month1:t[8],month2:t[12],name:t[15],owner:t[5],permission:t[2],size:t[7],type:t[1],year:t[14]}:null})(e)){let e,t;if("l"===r.type){const s=r.name.indexOf(" -> ");e=r.name.substring(0,s),t=r.name.substring(s+4)}else e=r.name;const s={acl:"+"===r.acl,date:void 0,group:r.group,name:e,owner:r.owner,rights:{group:r.permission.substring(3,6).replace(n,""),other:r.permission.substring(6,9).replace(n,""),user:r.permission.substring(0,3).replace(n,"")},size:parseInt(r.size,10),sticky:!1,target:t,type:r.type},i=s.rights&&s.rights.other.slice(-1);if(s.rights&&("t"===i?(s.rights.other=s.rights.other.slice(0,-1)+"x",s.sticky=!0):"T"===i&&(s.rights.other=s.rights.other.slice(0,-1),s.sticky=!0)),void 0!==r.month1&&void 0!==r.date1&&void 0!==r.hour&&void 0!==r.minute){const e=a.get(r.month1.toLowerCase()),t=parseInt(r.date1,10),n=(new Date).getFullYear(),i=parseInt(r.hour,10),o=parseInt(r.minute,10);let p=e.toString(),d=t.toString(),u=i.toString(),c=o.toString();e<10&&(p="0"+e),t<10&&(d="0"+t),i<10&&(u="0"+i),o<10&&(c="0"+o),s.date=new Date(n+"-"+p+"-"+d+"T"+u+":"+c),s.date.getTime()-Date.now()>1008e5&&(s.date=new Date(n-1+"-"+e+"-"+t+"T"+i+":"+o)),Date.now()-s.date.getTime()>160704e5&&(s.date=new Date(n+1+"-"+e+"-"+t+"T"+i+":"+o))}else if(void 0!==r.month2&&void 0!==r.date2&&void 0!==r.year){const e=a.get(r.month2.toLowerCase()),t=parseInt(r.date2,10),n=parseInt(r.year,10);let i=e.toString(),o=t.toString();e<10&&(i="0"+e),t<10&&(o="0"+t),s.date=new Date(n+"-"+i+"-"+o+"T00:00")}return s}if(r=(e=>{const t=e.match(o);return t?{ampm:t[6],date:t[2],hour:t[4],isdir:t[8],minute:t[5],month:t[1],name:t[9],size:t[7],year:t[3]}:null})(e)){const e=parseInt(r.month,10),t=parseInt(r.date,10);let s=parseInt(r.year,10),n=parseInt(r.hour,10);const a=parseInt(r.minute,10);return s+=s<70?2e3:1900,"p"===r.ampm[0].toLowerCase()&&n<12?n+=12:"a"===r.ampm[0].toLowerCase()&&12===n&&(n=0),{date:new Date(s,e-1,t,n,a),name:r.name,size:r.isdir?0:parseInt(r.size,10),type:r.isdir?"d":"-"}}return t.test(e)?null:e}export{Parser as default,u as parseListEntry,d as parseMlsxEntry};
//# sourceMappingURL=parser.mjs.map
